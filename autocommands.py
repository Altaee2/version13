import asyncio
import os
from telethon import events, functions, types

# ูุงููุณ ุงูููุงู ุงููุดุทุฉ: ููุชุงุญ ุงููุงููุณ ูู ุงูุฏู ุงููุฑูุจ ูุงููููุฉ ูู ุงููููุฉ ุงูุจุฑูุฌูุฉ
active_auto_tasks = {}

async def setup_auto(client, admins_list):
    
    @client.on(events.NewMessage(outgoing=True))
    async def auto_handler(event):
        text = event.raw_text
        chat_id = event.chat_id
        me = await client.get_me()

        # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        # 1. ุฃูุฑ ุงูุชูุฑุงุฑ ุงูุณุฑูุน ุฌุฏุงู (0.001 ุซุงููุฉ)
        # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        if text.startswith(".ูุฑุฑ "):
            try:
                parts = text.split(" ", 2)
                if len(parts) < 3:
                    return await event.edit("โ๏ธ **ุนุฐุฑุงู ุฑููู.. ุฃุฑุณู ุงูุฃูุฑ ููุฐุง:**\n`.ูุฑุฑ [ุงูุนุฏุฏ] [ุงููุต]`")
                
                count = int(parts[1])
                msg = parts[2]
                
                await event.delete() # ุญุฐู ุฑุณุงูุฉ ุงูุฃูุฑ ููุญูุงุธ ุนูู ูุธูุฑ ุงููุญุงุฏุซุฉ
                
                for _ in range(count):
                    await client.send_message(chat_id, msg)
                    await asyncio.sleep(0.001) # ุณุฑุนุฉ ุฎูุงููุฉ ุซุงุจุชุฉ
            except Exception as e:
                pass

        # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        # 2. ุฃูุฑ ุงููุดุฑ ุงูุชููุงุฆู (ุนุงู / ุฎุงุต / ุณุฑู)
        # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        elif text.startswith(".ุชููุงุฆู "):
            try:
                # ุงูุตูุบุฉ: .ุชููุงุฆู [ุงูุฑุงุจุท] [ุงูุนุฏุฏ] [ุงูุซูุงูู] [ุงููุต]
                parts = text.split(" ", 4)
                if len(parts) < 5:
                    return await event.edit("โ๏ธ **ููุต ูู ูุนุทูุงุช ุงููุดุฑ!**\nุงูุตูุบุฉ ุงูุตุญูุญุฉ:\n`.ุชููุงุฆู [ุงูุฑุงุจุท] [ุงูุนุฏุฏ] [ุงูุซูุงูู] [ุงููููุดุฉ]`")
                
                link = parts[1]
                count = int(parts[2])
                seconds = int(parts[3])
                message_text = parts[4]

                # ูุญุต ุดุฑุท ุงูููุช (300 ุซุงููุฉ ูุญุฏ ุฃุฏูู)
                if seconds < 300:
                    return await event.edit("โ๏ธ **ุชูุจูู ุฃูุงู ูู ุณูุฑุณ ุฑููู!**\nูุฌุจ ุฃู ูููู ุงูููุช **300 ุซุงููุฉ** ุฃู ุฃูุซุฑ ูุชุฌูุจ ุญุธุฑ ุญุณุงุจู ูู ูุจู ุดุฑูุฉ ุชูุบุฑุงู.")

                await event.edit("โณ **ุฌุงุฑู ูุญุต ุงููุฏู ูุงูุงุชุตุงู ุจุงูุฎุงุฏู...**")

                try:
                    # ุฌูุจ ุงูููุงู (ุงููุฌููุนุฉ) ุณูุงุก ูุงูุช ููุฒุฑ ุฃู ุฑุงุจุท ุฎุงุต
                    target_entity = await client.get_entity(link)
                    target_chat = target_entity.id
                except Exception as e:
                    return await event.edit(f"โ **ูุดู ุงููุตูู ููุฑุงุจุท!**\nุชุฃูุฏ ุฃูู ุนุถู ูู ุงููุฌููุนุฉ ุฃู ุฃู ุงูุฑุงุจุท ุตุญูุญ.\n`{str(e)}` ")

                # ุฑุณุงูุฉ ุงูุชุฃููุฏ (ุณุฑูุฉ ูู ุงููุญููุธุงุช ุฃู ุนูููุฉ ูู ุงููุฌููุนุงุช)
                if chat_id == me.id:
                    await event.edit(
                        f"๐ต๏ธ **ุชูู ุชูููุนูููู ุงููููุดูุฑ ุงููุณูุฑู ุจูููุฌูุงุญ**\n"
                        f"โโโโโโโโโโโโโโโโโโ\n"
                        f"๐ **ุงููููุฏู :** {target_entity.title}\n"
                        f"๐ข **ุงููุนูุฏุฏ :** {count} ุฑุณุงูุฉ\n"
                        f"โฑ **ุงููููุงุตูู :** {seconds} ุซุงููุฉ\n"
                        f"โโโโโโโโโโโโโโโโโโ\n"
                        f"โ ุณุฃุจุฏุฃ ุงููุดุฑ ุงูุขู ูู ุงูููุงููุณ.."
                    )
                else:
                    await event.edit(f"โ **ุชู ุจุฏุก ุงููุดุฑ ุงูุชููุงุฆู ูู ูุฐู ุงููุฌููุนุฉ.**")

                # ุฅุฐุง ูุงูุช ููุงู ูููุฉ ูุฏููุฉ ูููุณ ุงููุฌููุนุฉุ ูุชู ุฅููุงููุง ุฃููุงู
                if target_chat in active_auto_tasks:
                    active_auto_tasks[target_chat].cancel()

                # ุชุนุฑูู ูุธููุฉ ุงููุดุฑ ูู ุงูุฎูููุฉ
                async def auto_post_task(t_chat, t_count, t_seconds, t_msg):
                    sent = 0
                    while sent < t_count:
                        try:
                            await client.send_message(t_chat, t_msg)
                            sent += 1
                        except:
                            pass # ุงุณุชูุฑุงุฑ ุงููุญุงููุฉ ูู ุญุงู ูุฌูุฏ ุชูููุฏ ุจุณูุท
                        if sent >= t_count: break
                        await asyncio.sleep(t_seconds)
                    
                    if t_chat in active_auto_tasks:
                        del active_auto_tasks[t_chat]

                # ุชุฎุฒูู ุงููููุฉ ูุชูุนูููุง
                active_auto_tasks[target_chat] = asyncio.create_task(
                    auto_post_task(target_chat, count, seconds, message_text)
                )

            except Exception as e:
                await event.edit(f"โ๏ธ **ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุชููุน:**\n`{str(e)}` ")

        # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        # 3. ุฃูุฑ ุฅููุงู ุงููุดุฑ (ุฐูู ูุดุงูู)
        # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        elif text == ".ุงููุงู ุงูุชููุงุฆู":
            # ุงูุญุงูุฉ ุงูุฃููู: ุฅุฐุง ุฃุฑุณู ุงูุฃูุฑ ูู ุงูุฑุณุงุฆู ุงููุญููุธุฉ (ุฅููุงู ุดุงูู)
            if chat_id == me.id:
                if active_auto_tasks:
                    total = len(active_auto_tasks)
                    for t_id in list(active_auto_tasks.keys()):
                        active_auto_tasks[t_id].cancel()
                        del active_auto_tasks[t_id]
                    await event.edit(f"๐ **ุชูู ุฅููููุงู ุฌูููููุน ุงููููููุงู!**\nุชู ุฅููุงุก ({total}) ุนูููุฉ ูุดุฑ ูู ูุงูุฉ ุงููุฑูุจุงุช.")
                else:
                    await event.edit("โ๏ธ **ูุง ุชูุฌุฏ ุฃู ููุงู ูุดุฑ ูุดุทุฉ ุญุงููุงู.**")
            
            # ุงูุญุงูุฉ ุงูุซุงููุฉ: ุฅุฐุง ุฃุฑุณู ุงูุฃูุฑ ุฏุงุฎู ูุฌููุนุฉ ูุนููุฉ
            else:
                if chat_id in active_auto_tasks:
                    active_auto_tasks[chat_id].cancel()
                    del active_auto_tasks[chat_id]
                    await event.edit("๐ **ุชู ุฅููุงู ุงููุดุฑ ุงูุชููุงุฆู ูู ูุฐู ุงููุฌููุนุฉ ููุท.**")
                else:
                    await event.edit("โ๏ธ **ูุง ููุฌุฏ ูุดุฑ ุชููุงุฆู ูุดุท ูู ูุฐู ุงูุฏุฑุฏุดุฉ.**")

        # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        # 4. ูุงุฆูุฉ ุงููุณุงุนุฏุฉ .ู9 (ูุฒุฎุฑูุฉ ูููุณูุฉ)
        # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        elif text == ".ู9":
            help_text = f"""
**โญโโโ[ ๐ข ููุงุฆูููุฉ ุงููููุดูุฑ ูุงููุชููุฑุงุฑ ]โโโโฎ**

**โ๏ธ ุฃูุงููุฑ ุงููุชูููุฑุงุฑ (ุงูุณุฑูุน) :**
โ `.ูุฑุฑ` [ุงูุนุฏุฏ] [ุงููุต]
ู ุงูููุช ุซุงุจุช (0.001 ุซุงููุฉ) ูููุฌูู ุงูุณุฑูุน.

**๐ค ุฃูุงููุฑ ุงููููุดูุฑ (ุงูุชููุงุฆู) :**
โ `.ุชููุงุฆู` [ุงูุฑุงุจุท] [ุงูุนุฏุฏ] [ุงูุซูุงูู] [ุงููุต]
ู ูุฏุนู ุงูุฑูุงุจุท ุงูุนุงูุฉ (@..) ูุงูุฑูุงุจุท ุงูุฎุงุตุฉ.
ู **ููุงุญุธุฉ:** ุฃูู ููุช ูุณููุญ ูู 300 ุซุงููุฉ.

**๐ต๏ธ ููููุฒุฉ ุงููุณูุฑููุฉ ุงููุชูุงููุฉ :**
โ ุนูุฏ ุฅุฑุณุงู ุฃูุฑ ุงููุดุฑ ูู (ุงูุฑุณุงุฆู ุงููุญููุธุฉ) ุณูููู ุงูุณูุฑุณ ุจุงููุดุฑ ูู ุงููุฏู ุงููุทููุจ ุฏูู ุฃู ุชุธูุฑ ุฑุณุงุฆู ุงูุฃูุงูุฑ ูู ุงููุฌููุนุฉ ุงููุณุชูุฏูุฉ.

**๐ ุฃูุงููุฑ ุงูุฅููููุงู :**
โ ุฃุฑุณู `.ุงููุงู ุงูุชููุงุฆู` ูู ุงููุฌููุนุฉ ูุฅููุงููุง.
โ ุฃุฑุณู `.ุงููุงู ุงูุชููุงุฆู` ูู ุงููุญููุธุฉ ูุฅููุงู (ุงููู).

โโโโโโโโโโโโโโโโโโ
**๐ค ุงููููุทููุฑ : @N_QQ_H**
**๐ ุงููููููุงุฉ : @SORS_RECO**
**โฐโโโโโโโโโโโโโโโฏ**
"""
            await event.edit(help_text)
